# Deep Research Planning Agent v2.0 使用指南

## 概述

Deep Research Planning Agent v2.0 是基于 Agno 框架重构的智能研究规划助手，采用固定工具流架构，专门用于帮助用户制定详细、结构化的研究计划。新版本将规划生成、计划展示、用户反馈评估和结构化输出分离为独立组件，提供更清晰的交互流程。

## 架构设计

### 工作流架构图

```
用户输入研究问题
        ↓
   规划生成步骤
   (plan_generator_agent)
        ↓
   计划展示步骤
   (格式化展示 + 收集反馈)
        ↓
   反馈评估步骤
   (feedback_evaluator_agent)
        ↓
     路由决策
    ↙        ↘
用户满意      需要修改
   ↓           ↓
最终输出步骤   返回规划生成
(结构化JSON)   (重新开始)
```

## 核心特性

### 1. 固定工具流架构
- **规划生成步骤**：使用专门的 plan_generator_agent 生成研究计划
- **计划展示步骤**：格式化展示计划并收集用户反馈
- **反馈评估步骤**：使用 feedback_evaluator_agent 分析用户反馈
- **结构化输出步骤**：确认后以 JSON 格式输出最终计划

### 2. 智能问题分析
- 自动分析用户提出的研究问题
- 识别研究领域和关键要素
- 确定研究的复杂度和范围

### 3. 背景信息搜索
- 集成 Tavily 搜索工具
- 自动搜索相关背景信息
- 为计划制定提供信息支撑

### 4. 结构化计划生成
- 生成包含 3-8 个子任务的详细计划
- 每个子任务包含：描述、预期产出、重要性评估
- 提供预估完成时间

### 5. 智能反馈评估
- 自动分析用户反馈内容
- 判断是否需要修改或重新生成计划
- 提供具体的修改建议

### 6. 多语言支持
- 支持中文和英文交互
- 自动适应用户的语言偏好

## 技术特点

### 1. 工作流架构
- 基于 Agno v2 Workflow 构建
- 使用 Step 和 Router 组织执行流程
- 支持条件分支和循环执行

### 2. 组件分离设计
- **规划生成组件**：专门负责计划生成，使用 ResearchPlan 数据模型
- **反馈评估组件**：专门分析用户反馈，使用 FeedbackEvaluation 数据模型
- **展示组件**：负责计划展示和用户交互
- **输出组件**：处理最终的结构化输出

### 3. Human-in-the-Loop 设计
- 采用人机协作模式
- 用户可以在计划生成过程中提供反馈
- 支持多轮交互和计划迭代

### 4. Rich UI 界面
- 使用 Rich 库提供美观的命令行界面
- 彩色输出和格式化显示
- 交互式用户输入

### 5. 错误处理
- 完善的异常处理机制
- 用户友好的错误提示
- 支持操作取消和重试

### 6. 模块化设计
- 清晰的代码结构
- 可扩展的工具集成
- 易于维护和升级

## 使用方法

### 1. 通过 main.py 运行（推荐）

```bash
# 运行规划工作流
python main.py planning
```

### 2. 直接运行

```bash
# 直接运行规划工作流
python src/deep_research/planning_agent.py
```

### 3. 测试运行

```bash
# 运行自动化测试
python test_planning_agent.py test

# 交互式测试
python test_planning_agent.py
```

## 使用流程

### 工作流步骤说明

1. **启动工作流**
   - 运行命令启动规划工作流 v2.0
   - 系统显示欢迎信息和架构说明

2. **输入研究问题**
   - 用户输入要研究的问题或主题
   - 工作流开始执行第一步：规划生成

3. **规划生成步骤**
   - 使用专门的 plan_generator_agent 分析问题
   - 可能会自动搜索背景信息（需用户确认）
   - 生成结构化的研究计划（ResearchPlan 格式）

4. **计划展示步骤**
   - 系统以格式化的方式展示生成的计划
   - 包含计划标题、概述、子任务详情等
   - 收集用户反馈：满意确认、需要修改、重新制定

5. **反馈评估步骤**
   - 使用 feedback_evaluator_agent 分析用户反馈
   - 判断用户是否满意当前计划
   - 生成下一步行动建议（FeedbackEvaluation 格式）

6. **路由决策**
   - 如果用户满意：进入最终输出步骤
   - 如果需要修改：返回规划生成步骤重新开始

7. **最终输出步骤**
   - 用户满意时，以结构化 JSON 格式输出最终计划
   - 显示确认信息和完整的计划内容
   - 工作流完成

### 示例对话流程

```
用户: 我想研究人工智能在医疗诊断中的应用

系统: [规划生成步骤]
正在分析您的研究问题...
即将执行: search_background_info
是否继续执行此操作? [Y/n]

用户: Y

系统: [计划展示步骤]
==========================================================
                    AI医疗诊断应用研究计划
==========================================================

概述: 深入研究人工智能技术在医疗诊断领域的应用现状、技术原理、实施挑战和未来发展趋势
预估时间: 8-10周

研究子任务:

1. AI医疗诊断技术现状调研
   预期产出: 技术现状分析报告
   重要性: 高

2. 核心算法和技术原理分析
   预期产出: 技术原理详解文档
   重要性: 高

...

请选择您的反馈:
  1. 满意，确认此计划
  2. 需要修改
  3. 重新制定计划

用户: 1

系统: [反馈评估步骤]
正在评估用户反馈...

系统: [最终输出步骤]
🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉🎉
                    研究计划已确认！

最终确认的研究计划:
{
  "title": "AI医疗诊断应用研究计划",
  "overview": "深入研究人工智能技术在医疗诊断领域的应用现状...",
  "subtasks": [...],
  "estimated_duration": "8-10周"
}
```

## 配置说明

### 1. Prompt 模板

工作流使用多个专门的 prompt 模板：

- **plan_generator_agent.json**: 规划生成 Agent 的模板
  - 专门负责分析问题和生成研究计划
  - 输出 ResearchPlan 格式的结构化数据

- **feedback_evaluator_agent.json**: 反馈评估 Agent 的模板
  - 专门负责分析用户反馈
  - 输出 FeedbackEvaluation 格式的评估结果

### 2. 工具配置

- **search_background_info**: 背景信息搜索工具
  - 使用 Tavily API 进行网络搜索
  - 需要配置 TAVILY_API_KEY 环境变量
  - 集成了用户确认机制

### 3. 数据模型

- **ResearchPlan**: 研究计划数据模型
  - title: 计划标题
  - overview: 计划概述
  - subtasks: 子任务列表
  - estimated_duration: 预估时间

- **FeedbackEvaluation**: 反馈评估数据模型
  - action: 下一步行动
  - is_satisfied: 用户满意度
  - modification_suggestions: 修改建议
  - reason: 评估原因

## 重要注意事项

1. **架构变更**
   - v2.0 版本采用全新的工作流架构
   - 旧版本的 `create_planning_agent()` 函数已弃用
   - 请使用 `create_planning_workflow()` 和相关工作流函数

2. **环境变量配置**
   - 确保已配置 TAVILY_API_KEY
   - 检查 Agno 相关的环境变量设置

3. **网络连接**
   - 搜索功能需要稳定的网络连接
   - 如网络不佳，可能影响背景信息搜索

4. **用户交互**
   - 请仔细阅读系统提示
   - 及时提供反馈以获得更好的计划
   - 新版本的交互流程更加清晰和结构化

5. **计划质量**
   - 提供详细的研究问题描述
   - 明确说明研究目标和期望

## 故障排除

### 常见问题

1. **工作流执行失败**
   - 检查所有 prompt 模板文件是否存在
   - 确认 plan_generator_agent.json 和 feedback_evaluator_agent.json 已创建

2. **搜索工具无法使用**
   - 检查 TAVILY_API_KEY 是否正确配置
   - 确认网络连接正常

3. **Agent 响应缓慢**
   - 可能是模型推理时间较长
   - 检查网络连接和 API 服务状态

4. **计划格式异常**
   - 检查数据模型定义是否正确
   - 重新启动工作流
   - 尝试重新描述研究问题

5. **向后兼容问题**
   - 旧版本的函数调用会显示弃用警告
   - 建议更新代码使用新的工作流接口

### 调试模式

可以通过修改工作流中的相关参数来查看详细的执行信息和调试输出。

## 扩展开发

### 添加新的工作流步骤

1. 定义新的步骤执行函数
2. 创建对应的 Step 对象
3. 将步骤添加到工作流的 steps 列表中
4. 更新路由逻辑（如需要）

### 添加新工具

1. 在相应的步骤函数中定义新的工具
2. 使用 `@tool` 装饰器标记
3. 将工具添加到对应 Agent 的 tools 列表中

### 自定义 Prompt

1. 修改对应的 prompt 模板文件：
   - `prompts/plan_generator_agent.json`
   - `prompts/feedback_evaluator_agent.json`
2. 调整 instructions 和 description 内容
3. 重新启动工作流使配置生效

### 扩展数据模型

1. 修改 ResearchPlan 或 FeedbackEvaluation 模型
2. 添加新的字段和验证规则
3. 更新相关的处理逻辑

### 集成其他搜索引擎

1. 实现新的搜索工具函数
2. 配置相应的 API 密钥
3. 更新工具列表

## 未来计划

基于新的工作流架构，后续将开发：

1. **Commander Agent**: 实现任务分发和协调工作流
2. **Researcher Agent**: 执行具体研究任务的工作流
3. **Reflection Agent**: 提供研究质量评估的工作流
4. **Summarizer Agent**: 生成研究总结报告的工作流
5. **多工作流协作**: 构建完整的深度研究系统
6. **工作流编排**: 实现多个工作流之间的协调和数据传递

## 版本历史

### v2.0 (当前版本)
- 重构为工作流架构
- 分离规划生成和反馈评估为独立组件
- 实现固定的工具流：生成 -> 展示 -> 评估 -> 输出
- 添加结构化数据模型
- 改进用户交互体验

### v1.0
- 基础的 Agent 架构
- 集成搜索和计划展示功能
- 支持人机交互和计划优化

---

**Deep Research Planning Agent v2.0** - 让研究规划更智能、更结构化！